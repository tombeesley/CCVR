---
title: "Report of CCVR03"
author: "Tom Beesley"
output:
  pdf_document: default
  html_document: default
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
date_compiled_title = c("PDF created on", date())
```

---
date: `r date_compiled_title`
---

```{r include = FALSE}
library(tidyverse)
library(broom)
library(kableExtra)
library(ggrepel)
library(afex)

theme_set(theme_classic())

setwd(dirname(rstudioapi::getActiveDocumentContext()$path)) # set wd to current file location

data <- read_csv("data_tidy_CCVR03.csv")

# split into main data and awareness phase
dataAw <- filter(data, phase == 2)
dataMain <- filter(data, phase == 1) %>% 
  mutate(TT = if_else(set %in% c(1,2), "repeated", "random"), # recode set into 2 variables
         targ_depth = if_else(set %in% c(1,3), "near", "far"),
         epoch = ceiling(block/5)) %>% 
  select(sub_exp:phase, epoch, block:set, TT, targ_depth, everything())

# did anyone not finish the main task? (yes, one participant)
did_not_finish <- dataMain %>% 
  group_by(subj) %>% 
  count() %>% 
  filter(n < 480)

# remove any participant that failed to finish the main task
dataMain <- dataMain %>% 
  filter(!subj %in% did_not_finish$subj)

```

**Summary of the DESIGN of the experiment**

The main control of the pattern generation is found in "CreatePats.m" in the experiment code folder

Set 1 - Near target repeated configurations Set 2 - Far target repeated configurations Set 3 - Near target random configurations\
Set 4 - Far target random configurations

**Analysis report**

```{r include = FALSE}

# get demographic information from each participant
data_demog <- 
  dataMain %>% 
  group_by(subj) %>% 
  slice(1) %>% # take top row
  ungroup() %>% 
  select(subj,sub_exp, age,gender)

# create summary stats of gender, number of participants
demog_summary <- 
  data_demog %>% 
  group_by(sub_exp) %>% 
  summarise(n = n(),
            mean_age = mean(age),
            sd_age = sd(age),
            males = sum(gender=="M"),
            females = sum(gender=="F"),
            non_binary = sum(!gender %in% c("M", "F")))

# summary statistics of response patterns. by sub_exp
basic_resp_stats <- 
  dataMain %>%
  group_by(sub_exp,subj) %>%
  summarise(mean_RT = mean(RT),
            mean_Extra_Resp = mean(num_additional_Rs),
            perc_Rs_Over1 = sum(num_additional_Rs>0)/n(),
            perc_Rs_Over2 = sum(num_additional_Rs>1)/n()) %>% 
  group_by(sub_exp) %>% 
  summarise_all(list(mean = mean, sd = sd)) %>% 
  select(-contains("subj")) 

# summary statistics of response patterns. by sub_exp
table_basic_resp_stats <- 
  basic_resp_stats %>% 
  pivot_longer(cols = mean_RT_mean:perc_Rs_Over2_sd, names_to = "stat") %>% 
  kable(digits = 2) %>% 
  kable_styling(latex_options = "hold_position", position = "left")

# what was the distribution of responses by experiment
dataMain %>% 
  filter(pattern %in% c(2,4)) %>% 
  group_by(sub_exp, num_additional_Rs) %>%
  summarise(n_trials = n(),
            mean_RT = mean(RT)) %>% 
  mutate(prop = n_trials/sum(n_trials)) %>% 
  filter(num_additional_Rs<10)

# filter trials with more than 2 responses (num additional Rs > 1), timeouts,
# and outlier RTs  
data_NO <- 
  dataMain %>% 
  filter(num_additional_Rs<=1, dist_to_T>=0) %>%  # too many responses and timeouts
  group_by(subj) %>% 
  mutate(zRT = scale(RT)) %>% 
  filter(between(zRT,-2.5,2.5)) %>% 
  ungroup() 

# what percentage of trials were removed for each participant?
perc_removed <- 
  data_NO %>%
  group_by(subj) %>% 
  summarise(perc = (1 - (n()/480))*100)

# compute normalised RT (norm_RT), for calculating w/s error bars (i.e., Cosin)
data_NO <- data_NO %>% 
  group_by(subj) %>% # within each experiment, and each subject
  summarise(sub_MeanRT = mean(RT)) %>% # calculate the mean RT for the subject
  mutate(sample_MeanRT = mean(sub_MeanRT)) %>% # the overall mean RT for the sample in that experiment
  ungroup() %>% # ungroup the data, to allow for removal of variable
  left_join(data_NO, by = "subj") %>% # join to the original data frame
  mutate(norm_RT = RT - sub_MeanRT + sample_MeanRT) %>% # compute the normalised RT, from the RT, subject mean and sample mean
  select(sub_exp, subj, age:RT, norm_RT, everything(), -sub_MeanRT, -sample_MeanRT)
  
```

There were `r demog_summary[demog_summary$sub_exp=="1A",'n']` participants in Experiment 1A and `r demog_summary[demog_summary$sub_exp=="1B",'n']` in Experiment 1B.

Summary statistics for RTs and number of responses made:

`r table_basic_resp_stats`

The major procedural differences between Experiment 1A and 1B was an improvement in the target detection method and the inclusion of a timeout of 10s in the latter.

Data processing: trials which led to timeouts, and trials that had more than one additional responses (i.e., up to 2 responses allowed) were removed. Following this, RTs greater or less than 2.5 SDs from the participant mean RT were removed. On average this resulted in the loss of `r round(mean(perc_removed$perc),1)`% of trials. Normalised RT was computed in order to create within-subject error bars in all plots.

```{r include=FALSE}

# summarise the overall mean RT for each P 
overall_RT_Means <- 
  data_NO %>% 
  group_by(sub_exp, subj) %>% 
  summarise(meanRT = mean(RT)) %>% 
  mutate(z_meanRT = scale(meanRT)) 

# Is anyone an outlier in terms of mean RT? 
overall_RT_Means %>% 
  filter(!between(z_meanRT, -2.5, 2.5)) # no Ps detected

```

```{r echo=FALSE}

# plot the boxplots of RT by sub-experiment
overall_RT_Means %>% 
  ggplot(aes(x = sub_exp, y = meanRT))+
  geom_boxplot(width = .2) +
  geom_point(size = 5, alpha = .2) +
  geom_text_repel(aes(label = subj), 
                  direction = 'y', 
                  nudge_x = .2, 
                  segment.colour = "red", 
                  colour = "red", 
                  segment.alpha = .2) +
  labs(title = "Boxplots with data labelled by participant ID",
       y = "Mean RT",
       x = "Experiment")

```

Mean RTs for each participant were computed and the mean across the sample was `r round(mean(overall_RT_Means$meanRT),0)` ms (SD = `r round(sd(overall_RT_Means$meanRT),0)`). No participants were identified as outliers in terms of RT.

```{r include=FALSE}
# full 4-way reveals sub_exp did not interact with any other factor.
data_NO %>% 
  group_by(sub_exp, subj, TT, targ_depth, epoch) %>% 
  summarise(meanRT = mean(RT)) %>% 
  aov_car(meanRT ~ Error(subj/(TT*targ_depth*epoch)) + sub_exp, data = .)
```

An ANOVA revealed that the sub-experiment factor (1A/1B) was not significant (F \< 1) and did not interact with any other factor. We therefore simplified the analysis to combine the data across the sub-experiment factor.

RTs were analysed by averaging the data across five consecutive blocks, producing 6 epochs of 80 trials. As can be seen from the figure, RTs were slower for near targets compared to far targets. A contextual cuing effect appears to be present for both the set of repeated configurations paired with near targets and those paired with far targets. Numerically the CC effect looks larger for those configurations paired with far targets.

```{r echo=FALSE, message = FALSE}
# main analysis of RT
data_NO <-  
  data_NO %>% 
  mutate(TT = factor(TT, levels = c("repeated", "random")),
         targ_depth = factor(targ_depth, levels = c("near", "far")))

legendLBLs <- c("Near-T-Repeated", "Near-T-Random", "Far-T-Repeated", "Far-T-Random")

# main RT figure
RT_avgs_figure <- 
  data_NO %>% 
  group_by(TT, targ_depth, epoch) %>% 
  summarise(meanRT = mean(RT), SE = sd(norm_RT)/sqrt(n())) %>% 
  ggplot(aes(x = epoch, y = meanRT, group = interaction(TT, targ_depth))) +
  geom_line() +
  geom_errorbar(aes(ymin = meanRT-SE, ymax = meanRT+SE), width = 0.1)+
  geom_point(aes(fill = interaction(TT, targ_depth), shape = interaction(TT, targ_depth)), size = 3) +
  scale_y_continuous(limits = c(1600, 3000), breaks = seq(1600,3000,200)) +
  scale_x_continuous(breaks = 1:6) +
  scale_fill_manual(name  ="",
                    labels = legendLBLs,
                    values = c("black", "white", "black", "white")) +
  scale_shape_manual(name = "",
                     labels = legendLBLs,
                     values = c(21,21,22,22))

RT_avgs_figure # print figure

# save data for statistical analysis
data_RT_ANOVA <- 
  data_NO %>% 
  group_by(subj, epoch, TT, targ_depth) %>% 
  summarise(meanRT = mean(RT))

# show ANOVA table here
data_RT_ANOVA %>% 
  aov_car(meanRT ~ Error(subj/(TT*targ_depth*epoch)), data = .)

# calculate a CC effect for each target depth
CC_effect <- 
  data_NO %>% 
  group_by(TT, targ_depth) %>% 
  summarise(meanRT = mean(RT)) %>% 
  pivot_wider(names_from = TT, values_from = meanRT) %>% 
  mutate(avgRT = rowMeans(select(.,random,repeated)),
         CCeffect = random - repeated)
```

ANOVA revealed main effects of trial type (a CC effect: faster RTs to Repeated than to Random configurations), target depth (faster RTs to far targets compared to near targets), and epoch (RTs decreased across epochs). The trial type by target depth interaction was significant, suggesting that the CC effect was greater in the case of configurations that had far targets compared to near targets. The trial type by epoch interaction was significant, indicating that RTs decreased more for repeated configurations compared to random configurations. The target depth by epoch interaction was also significant, indicating that RTs decreased more for configurations with far targets compared to those for near targets. The three way interaction was not significant.

```{r echo=FALSE, message = FALSE}
# create new variables with experiment specific names

CCVR03_demog_summary = demog_summary
CCVR03_basic_resp_stats = basic_resp_stats
CCVR03_perc_removed = perc_removed
CCVR03_overall_RT_Means = overall_RT_Means
CCVR03_RT_avgs_figure = RT_avgs_figure
CCVR03_data_RT_ANOVA = data_RT_ANOVA
CCVR03_CC_effect = CC_effect

save(CCVR03_demog_summary,
     CCVR03_basic_resp_stats,
     CCVR03_perc_removed,
     CCVR03_overall_RT_Means,
     CCVR03_RT_avgs_figure,
     CCVR03_data_RT_ANOVA,
     CCVR03_CC_effect,
     file = "../../CCVR_ms_1/CCVR03_export.Rdata")

```
